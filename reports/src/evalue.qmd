```{r}
#| label: evaluefunc
#| cache: true
#| cache.comments: false

coxvars <- modvars
coxvars[modvars %in% stratavars] <- paste0("strata(", coxvars[modvars %in% stratavars], ")")

evalfunc <- function(impdata, time, event, eventname, xvar = "shf_loopdiuretic_cat") {
  levs <- levels(rsdata %>% pull(!!sym(xvar)))
  nlevs <- length(levs)

  ## adjusted
  mod <- summary(pool(with(impdata, coxph(formula(paste0(
    "Surv(", time, ",", event, " == 'Yes') ~ ", xvar, "+", paste(coxvars, collapse = " + ")
  ))))))

  out <- data.frame(matrix(NA, ncol = 5, nrow = (nlevs - 1) * 2))
  out[, 2] <- c("Model estimates", "E-values")

  colnames(out) <- c("Loop diuretic", "Variable", "RR*", "Lower CI", "Upper CI")
  for (i in seq_along(levs[2:nlevs])) {
    out[i + (i - 1), 1] <- levs[i + 1]
    out[(i + (i - 1)):(i + (i - 1) + 1), 3:5] <-
      fn(
        evalue(HR(exp(mod$estimate[i]), rare = FALSE),
          lo = exp(mod$estimate[i] - global_z05 * mod$std.error[i]),
          hi = exp(mod$estimate[i] + global_z05 * mod$std.error[i])
        ),
        dig = 2
      )
  }
  return(out)
}

eval_pop1 <- evalfunc(
  impdata = imprsdata_pop1,
  time = "sos_outtime_hosphf",
  event = "sos_out_deathcvhosphf",
  eventname = "CVD/First HFH"
)
eval_pop2 <- evalfunc(
  impdata = imprsdata,
  time = "sos_outtime_hosphf",
  event = "sos_out_deathcvhosphf",
  eventname = "CVD/First HFH"
)
```

```{r}
#| label: tbl-evalue
#| cache: true
#| cache.comments: false
#| dependson: evaluefunc
#| tbl-cap: "Residual confounding - E-value"

out <- bind_cols(eval_pop1, eval_pop2 %>% select(-"Loop diuretic", -Variable)) %>%
  mutate(across(everything(), ~ str_replace_all(.x, "NA", "")))

colnames(out) <- c("", "", rep(c("RR*", "Lower CI", "Upper CI"), 2))

default_kable(out) %>%
  add_header_above(c(" ", " ", "Population 1" = 3, "Population 2" = 3)) %>%
  footnote(
    general_title = "",
    symbol = "Approximate conversions of the HR to RR are applied, assuming a non-rare outcome."
  )
```
